<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>WH40k Data-Slate — Infoczytnik</title>

<!-- Google Fonts (fallback do Calibri/Arial jeśli brak internetu) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Cinzel:wght@400;700&family=Rajdhani:wght@400;600&family=Black+Ops+One&family=Staatliches&family=Orbitron:wght@400;700&family=Questrial&family=Russo+One&display=swap" rel="stylesheet">

<style>
  :root{
    --accent:#00ff66;
    --font: Calibri, Arial, sans-serif;

    /* Bezpieczne marginesy tekstu (z zapasem, żeby nie nachodzić na ozdoby) */
    --screen-top: 14%;
    --screen-right: 14%;
    --screen-bottom: 22%;
    --screen-left: 18%;
  }

  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background:#000; overflow:hidden;}
  body{color:var(--accent); font-family:var(--font);}

  .wrap{
    width:100vw; height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#000;
    overflow:hidden;
  }

  .panel{
    position:relative;
    overflow:hidden;
    background:#000;
  }

  .layout-img{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:contain;
    object-position:center;
    user-select:none;
    -webkit-user-drag:none;
    pointer-events:none;
  }

  /* CRT / Scanlines overlay (delikatne, ale widoczne) */
  .crt::before{
    content:"";
    position:absolute;
    inset:0;
    pointer-events:none;
    background:
      repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,.05) 0px,
        rgba(255,255,255,.05) 1px,
        rgba(0,0,0,0) 3px,
        rgba(0,0,0,0) 7px
      );
    opacity:.24;
    mix-blend-mode: overlay;
    animation: scanMove 12s linear infinite;
  }
  .crt::after{
    content:"";
    position:absolute;
    inset:-2%;
    pointer-events:none;
    background:
      radial-gradient(closest-side, rgba(0,0,0,0) 62%, rgba(0,0,0,.65) 100%),
      rgba(255,255,255,.03);
    opacity:.60;
    animation: flickerBg 9s infinite;
  }
  @keyframes scanMove { 0%{transform:translateY(0)} 100%{transform:translateY(20px)} }
  @keyframes flickerBg {
    0%,92%,100%{opacity:.60}
    93%{opacity:.52}
    95%{opacity:.66}
    97%{opacity:.56}
  }

  /* Bezpieczne pole na tekst – scroll tylko tutaj */
  .screen{
    position:absolute;
    top:var(--screen-top);
    right:var(--screen-right);
    bottom:var(--screen-bottom);
    left:var(--screen-left);

    overflow:auto;
    -webkit-overflow-scrolling:touch;
    padding: clamp(14px, 2.4vw, 24px);

    display:none;
    text-shadow: 0 2px 6px rgba(0,0,0,.70);
  }

  /* ====== NOWE: „TRANSMISSION EFFECT” (puls + drganie) ======
     Efekt włączamy klasą .tx-on na .screen i trwa kilka sekund.
  */

  /* Puls jasności (miganie/oddychanie) */
  @keyframes txPulse {
    0%   { filter: brightness(1.00); opacity: 1; }
    10%  { filter: brightness(1.35); opacity: .98; }
    20%  { filter: brightness(.85); opacity: .92; }
    32%  { filter: brightness(1.25); opacity: 1; }
    45%  { filter: brightness(.90); opacity: .94; }
    60%  { filter: brightness(1.18); opacity: 1; }
    78%  { filter: brightness(.96); opacity: .98; }
    100% { filter: brightness(1.00); opacity: 1; }
  }

  /* Drganie (bardzo lekkie) */
  @keyframes txJitter {
    0%   { transform: translate(0,0); }
    8%   { transform: translate(0, 1px); }
    16%  { transform: translate(1px, 0); }
    24%  { transform: translate(0,-1px); }
    32%  { transform: translate(-1px,0); }
    40%  { transform: translate(0, 1px); }
    48%  { transform: translate(1px,-1px); }
    56%  { transform: translate(-1px,1px); }
    64%  { transform: translate(0,0); }
    72%  { transform: translate(1px,0); }
    80%  { transform: translate(0,-1px); }
    88%  { transform: translate(-1px,0); }
    100% { transform: translate(0,0); }
  }

  .tx-on{
    animation: txPulse 5.2s ease-out 1;
  }

  /* Drganie stosujemy na samym tekście, żeby scroll nie wariował */
  .tx-on .msg,
  .tx-on .prefixRow,
  .tx-on .suffixRow{
    animation: txJitter .55s linear 10;
  }

  /* Prefix / suffix / tekst */
  .prefixRow, .suffixRow{
    display:flex;
    align-items:center;
    gap: 10px;
  }

  .prefix, .suffix{
    color: rgba(255,255,255,.86);
    font-size: clamp(12px, 2.0vw, 16px);
    letter-spacing: 1.5px;
    margin: 0 0 10px 0;
    white-space: pre-wrap;
  }
  .suffix{ margin-top: 12px; }

  .msg{
    position:relative;
    font-size: clamp(18px, 3.4vw, 32px);
    line-height: 1.35;
    white-space: pre-wrap;
    word-break: break-word;
    color: var(--accent);
    text-shadow: 0 0 14px rgba(0,255,120,.10), 0 2px 6px rgba(0,0,0,.70);
  }

  /* miejsce na logo (na razie ukryte, włączymy w następnym kroku) */
  .logo{
    width: 34px;
    height: 34px;
    object-fit: contain;
    display:none; /* włączymy później */
    opacity: .92;
    filter: drop-shadow(0 2px 6px rgba(0,0,0,.7));
  }

  /* Audio unlock overlay */
  .unlock{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,.88);
    color:rgba(255,255,255,.9);
    font-family: Calibri, Arial, sans-serif;
    z-index:9999;
    text-align:center;
    cursor:pointer;
    padding:24px;
  }
  .unlock .box{
    border:1px solid rgba(255,255,255,.18);
    border-radius:16px;
    padding:18px 16px;
    max-width:560px;
    background:rgba(0,0,0,.35);
  }
  .unlock .title{font-size:18px; margin-bottom:8px;}
  .unlock .hint{font-size:13px; opacity:.78; line-height:1.35;}
  .unlock .tiny{margin-top:10px; font-size:12px; opacity:.6;}

  /* Debug overlay */
  #debug{
    position:fixed;
    left:8px; bottom:8px;
    font-family: Consolas, "Courier New", monospace;
    font-size:11px;
    color:rgba(255,255,255,.85);
    background:rgba(0,0,0,.55);
    border:1px solid rgba(255,255,255,.16);
    border-radius:12px;
    padding:10px;
    max-width:min(92vw,640px);
    white-space:pre-wrap;
    z-index:10000;
    display:none;
    max-height: 40vh;
    overflow:auto;
  }
</style>
</head>

<body>
  <div class="unlock" id="unlock">
    <div class="box">
      <div class="title">Kliknij raz, aby odblokować dźwięk</div>
      <div class="hint">
        Chrome blokuje audio, dopóki w tej karcie nie wykonasz akcji.
        To jednorazowe (po odświeżeniu trzeba kliknąć ponownie).
      </div>
      <div class="tiny">(Kliknij gdziekolwiek)</div>
    </div>
  </div>

  <div class="wrap">
    <div class="panel crt" id="panel">
      <img class="layout-img" id="layoutImg" alt="layout" />
      <div class="screen" id="screen">
        <div class="prefixRow">
          <img class="logo" id="logo" alt="logo" />
          <div class="prefix" id="prefixLine"></div>
        </div>

        <div class="msg" id="msg"></div>

        <div class="suffixRow">
          <div class="suffix" id="suffixLine"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="debug"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCVoWzXtO-vipsxnvZlFkcqcNgYYuH3osc",
    authDomain: "wh40k-data-slate.firebaseapp.com",
    projectId: "wh40k-data-slate",
    storageBucket: "wh40k-data-slate.firebasestorage.app",
    messagingSenderId: "382792444120",
    appId: "1:382792444120:web:9eb27e2ed29109ac838fad"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const DEFAULT_PING_URL = "assets/audio/global/Ping.mp3";
  const DEFAULT_MSG_URL  = "assets/audio/global/Message.mp3";

  const LAYOUT_BG = {
    inquisition: "assets/layouts/inquisition/DataSlate_Inq.png",
    mechanicus:  "assets/layouts/mechanicus/DataSlate_04.png",
    militarum:   "assets/layouts/militarum/DataSlate_04.png",
    chaos_undivided: "assets/layouts/chaos_undivided/DataSlate_04.png",
    khorne:      "assets/layouts/khorne/DataSlate_04.png",
    nurgle:      "assets/layouts/nurgle/DataSlate_04.png",
    tzeentch:    "assets/layouts/tzeentch/DataSlate_04.png",
    slaanesh:    "assets/layouts/slaanesh/DataSlate_04.png",
  };

  const LAYOUT_AR = {
    inquisition: 707/1023,
    default04:   1131/1600,
  };

  const SCREEN_INSETS = {
    inquisition: { top:"14%", right:"14%", bottom:"26%", left:"18%" },
    default04:   { top:"14%", right:"14%", bottom:"22%", left:"18%" },
  };

  const FONT_STACK = {
    mechanicus:      '"Share Tech Mono", Calibri, Arial, sans-serif',
    inquisition:     '"Cinzel", Calibri, Arial, sans-serif',
    militarum:       '"Rajdhani", Calibri, Arial, sans-serif',
    khorne:          '"Black Ops One", Calibri, Arial, sans-serif',
    nurgle:          '"Staatliches", Calibri, Arial, sans-serif',
    tzeentch:        '"Orbitron", Calibri, Arial, sans-serif',
    slaanesh:        '"Questrial", Calibri, Arial, sans-serif',
    chaos_undivided: '"Russo One", Calibri, Arial, sans-serif',
  };

  // Przygotowane pod przyszłość (foldery w assets/logos/...)
  // Na razie logo jest ukryte w CSS (display:none). Włączymy w następnym kroku.
  const FACTION_LOGO = {
    inquisition: "assets/logos/inquisition.png",
    mechanicus:  "assets/logos/mechanicus.png",
    militarum:   "assets/logos/militarum.png",
    chaos_undivided: "assets/logos/chaos_undivided.png",
    khorne:      "assets/logos/khorne.png",
    nurgle:      "assets/logos/nurgle.png",
    tzeentch:    "assets/logos/tzeentch.png",
    slaanesh:    "assets/logos/slaanesh.png",
  };

  const el = {
    unlock: document.getElementById("unlock"),
    panel: document.getElementById("panel"),
    layoutImg: document.getElementById("layoutImg"),
    screen: document.getElementById("screen"),
    prefixLine: document.getElementById("prefixLine"),
    suffixLine: document.getElementById("suffixLine"),
    msg: document.getElementById("msg"),
    logo: document.getElementById("logo"),
    debug: document.getElementById("debug"),
  };

  const debugOn = new URLSearchParams(location.search).get("debug") === "1";
  function dbg(s){
    console.log("[Infoczytnik]", s);
    if(!debugOn) return;
    el.debug.style.display = "block";
    el.debug.textContent = (el.debug.textContent + "\n" + s).trim();
    el.debug.scrollTop = el.debug.scrollHeight;
  }

  let audioArmed = false;
  function armAudio(){
    if(audioArmed) return;
    audioArmed = true;
    el.unlock.style.display = "none";
    dbg("AUDIO ARMED");
  }
  el.unlock.addEventListener("click", armAudio);
  window.addEventListener("keydown", armAudio);

  async function playUrlOnce(url, kind){
    dbg(`play(${kind}): ${url}`);
    if(!audioArmed){ dbg("BLOCKED: audio not armed"); return; }
    try{
      const a = new Audio(url);
      a.addEventListener("error", () => dbg(`Audio element error (${kind})`));
      await a.play();
      dbg(`OK: playing (${kind})`);
    }catch(e){
      dbg(`ERROR play(${kind}): ${e?.message || e}`);
    }
  }

  function fitPanel(ar){
    const vw = window.innerWidth;
    const vh = window.innerHeight;

    let h = vh;
    let w = h * ar;

    if(w > vw){
      w = vw;
      h = w / ar;
    }

    el.panel.style.width  = Math.round(w) + "px";
    el.panel.style.height = Math.round(h) + "px";
  }

  function setInsets(preset){
    document.documentElement.style.setProperty("--screen-top", preset.top);
    document.documentElement.style.setProperty("--screen-right", preset.right);
    document.documentElement.style.setProperty("--screen-bottom", preset.bottom);
    document.documentElement.style.setProperty("--screen-left", preset.left);
  }

  let currentAr = LAYOUT_AR.default04;

  function applyLayout(factionKey, color){
    const key = (factionKey && LAYOUT_BG[factionKey]) ? factionKey : "mechanicus";

    el.layoutImg.src = LAYOUT_BG[key] || LAYOUT_BG.mechanicus;

    document.documentElement.style.setProperty("--font", FONT_STACK[key] || 'Calibri, Arial, sans-serif');
    document.documentElement.style.setProperty("--accent", color || "#00ff66");

    if(key === "inquisition"){
      setInsets(SCREEN_INSETS.inquisition);
      currentAr = LAYOUT_AR.inquisition;
    }else{
      setInsets(SCREEN_INSETS.default04);
      currentAr = LAYOUT_AR.default04;
    }
    fitPanel(currentAr);

    // LOGO (na razie nie pokazujemy – włączymy w następnym kroku)
    el.logo.src = FACTION_LOGO[key] || "";
  }

  // ====== TRANSMISSION EFFECT (miganie + drganie) ======
  let txTimer = null;
  function triggerTransmissionEffect(){
    el.screen.classList.remove("tx-on"); // restart
    void el.screen.offsetWidth;          // wymuszenie reflow
    el.screen.classList.add("tx-on");
    if(txTimer) clearTimeout(txTimer);
    txTimer = setTimeout(()=> el.screen.classList.remove("tx-on"), 5400);
  }

  function showMessage(prefix, text, suffix){
    el.prefixLine.textContent = prefix || "";
    el.msg.textContent = text || "";
    el.suffixLine.textContent = suffix || "";
    el.screen.style.display = "block";
    el.screen.scrollTop = 0;
    triggerTransmissionEffect();
  }

  function hideTextKeepLayout(){
    el.prefixLine.textContent = "";
    el.msg.textContent = "";
    el.suffixLine.textContent = "";
    el.screen.style.display = "none";
  }

  window.addEventListener("resize", () => fitPanel(currentAr));

  const currentRef = doc(db, "dataslate", "current");
  let lastNonce = null;

  onSnapshot(currentRef, (snap)=>{
    if(!snap.exists()){
      dbg("current doc missing");
      return;
    }
    const d = snap.data() || {};
    dbg(`current: type=${d.type} faction=${d.faction} nonce=${d.nonce}`);

    if(d.nonce && d.nonce === lastNonce) return;
    lastNonce = d.nonce || null;

    const faction = d.faction || "mechanicus";
    const color   = d.color || d.fontColor || "#00ff66";

    applyLayout(faction, color);

    if(d.type === "clear"){
      hideTextKeepLayout();
      return;
    }

    if(d.type === "ping"){
      triggerTransmissionEffect();
      const pingUrl = d.pingUrl || DEFAULT_PING_URL;
      playUrlOnce(pingUrl, "ping");
      return;
    }

    if(d.type === "message"){
      const prefix = d.prefix ?? "";
      const text   = d.text ?? "";
      const suffix = d.suffix ?? "";

      if((text || "").trim().length === 0){
        hideTextKeepLayout();
      }else{
        showMessage(prefix, text, suffix);
      }

      const msgUrl = d.msgUrl || d.messageUrl || DEFAULT_MSG_URL;
      playUrlOnce(msgUrl, "message");
      return;
    }
  }, (err)=>{
    dbg("ERROR snapshot: " + (err?.message || err));
  });

  // Start: pokaż layout domyślny, tekst ukryty
  applyLayout("mechanicus", "#00ff66");
  hideTextKeepLayout();
  dbg("ready");
</script>
</body>
</html>
