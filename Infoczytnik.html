<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>WH40k Data-Slate — Infoczytnik</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Cinzel&family=Rajdhani&family=Black+Ops+One&family=Staatliches&family=Orbitron&family=Questrial&family=Russo+One&display=swap" rel="stylesheet">

<style>
:root{
  --layout-bg: none;
  --accent: #00ff66;
  --font: 'Share Tech Mono', Calibri, monospace;

  /* bezpieczne marginesy – ustawiane z JS */
  --screen-top: 12%;
  --screen-right: 12%;
  --screen-bottom: 20%;
  --screen-left: 16%;
}

html,body{
  margin:0;
  padding:0;
  height:100%;
  background:#000;
  color:#0f0;
  font-family:var(--font);
}

/* CENTROWANIE PANELU */
.wrap{
  height:100%;
  width:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#000;
  overflow:hidden;
}

/* PANEL Z TŁEM */
.panel{
  position:relative;
  overflow:hidden;

  height:100vh;
  width:auto;
  max-width:100vw;

  /* domyślne proporcje DataSlate_04 */
  aspect-ratio: 1131 / 1600;

  background-color:#000;
  background-image:var(--layout-bg);
  background-size:contain;
  background-position:center;
  background-repeat:no-repeat;
}

/* różne proporcje layoutów */
.panel[data-ar="inq"]{ aspect-ratio: 707 / 1023; }
.panel[data-ar="04"] { aspect-ratio: 1131 / 1600; }

/* BEZPIECZNE POLE TEKSTU */
.screen{
  position:absolute;
  top:var(--screen-top);
  right:var(--screen-right);
  bottom:var(--screen-bottom);
  left:var(--screen-left);

  padding:clamp(14px,2.5vw,24px);
  overflow:auto;

  color:var(--accent);
  font-family:var(--font);
  text-shadow:0 2px 6px rgba(0,0,0,.65);

  display:none;
}

/* TEKST */
.line{
  opacity:.9;
  font-size:clamp(14px,2vw,18px);
  letter-spacing:2px;
  margin:0 0 0.6em 0;
}

.msg{
  font-size:clamp(18px,3vw,28px);
  line-height:1.4;
  margin:0.4em 0;
  white-space:pre-wrap;
}

/* DELIKATNE EFEKTY */
@keyframes flicker{
  0%,100%{opacity:1;}
  50%{opacity:.96;}
}
.screen{ animation:flicker 6s infinite; }

/* OVERLAY AUDIO */
#audioUnlock{
  position:fixed;
  inset:0;
  background:#000;
  color:#0f0;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  cursor:pointer;
  z-index:9999;
  font-size:22px;
}

/* DEBUG */
#debug{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  max-height:40%;
  overflow:auto;
  background:rgba(0,0,0,.85);
  color:#0f0;
  font-family:monospace;
  font-size:12px;
  padding:6px;
  display:none;
}
</style>
</head>

<body>

<div id="audioUnlock">Kliknij, aby odblokować dźwięk</div>

<div class="wrap" id="wrap">
  <div class="panel" id="panel">
    <div class="screen" id="screen">
      <div class="line" id="prefixLine"></div>
      <div class="msg" id="msg"></div>
      <div class="line" id="suffixLine"></div>
    </div>
  </div>
</div>

<div id="debug"></div>

<script type="module">
/* ===================== FIREBASE ===================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCVoWzXtO-vipsxnvZlFkcqcNgYYuH3osc",
  authDomain: "wh40k-data-slate.firebaseapp.com",
  projectId: "wh40k-data-slate",
  storageBucket: "wh40k-data-slate.firebasestorage.app",
  messagingSenderId: "382792444120",
  appId: "1:382792444120:web:9eb27e2ed29109ac838fad"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ===================== CONFIG ===================== */

const DEFAULT_PING_URL =
  "assets/audio/global/Ping.mp3";

const DEFAULT_MSG_URL =
  "assets/audio/global/Message.mp3";

const LAYOUT_BG = {
  inquisition: "assets/layouts/inquisition/DataSlate_Inq.png",
  mechanicus:  "assets/layouts/mechanicus/DataSlate_04.png",
  militarum:   "assets/layouts/militarum/DataSlate_04.png",
  chaos_undivided:"assets/layouts/chaos_undivided/DataSlate_04.png",
  khorne:      "assets/layouts/khorne/DataSlate_04.png",
  nurgle:      "assets/layouts/nurgle/DataSlate_04.png",
  tzeentch:    "assets/layouts/tzeentch/DataSlate_04.png",
  slaanesh:   "assets/layouts/slaanesh/DataSlate_04.png",
};

const SCREEN_INSETS = {
  inquisition:{ top:"10%", right:"12%", bottom:"24%", left:"16%" },
  default04:  { top:"12%", right:"12%", bottom:"20%", left:"16%" },
};

const LAYOUTS = {
  mechanicus:{
    font:"'Share Tech Mono', Calibri, monospace",
    prefixes:["++ ENGAGE LITURGY ++"],
    suffixes:["++ PRAY TO THE CODE ++"]
  }
};

/* ===================== ELEMENTY ===================== */
const el = {
  unlock:document.getElementById("audioUnlock"),
  wrap:document.getElementById("wrap"),
  panel:document.getElementById("panel"),
  screen:document.getElementById("screen"),
  prefix:document.getElementById("prefixLine"),
  msg:document.getElementById("msg"),
  suffix:document.getElementById("suffixLine"),
  debug:document.getElementById("debug")
};

/* ===================== DEBUG ===================== */
const debug = new URLSearchParams(location.search).get("debug")==="1";
function log(t){
  if(!debug) return;
  el.debug.style.display="block";
  el.debug.textContent+=t+"\n";
  el.debug.scrollTop=el.debug.scrollHeight;
}

/* ===================== AUDIO ===================== */
let audioArmed=false;
el.unlock.onclick=()=>{
  audioArmed=true;
  el.unlock.style.display="none";
  log("AUDIO ARMED");
};

function playOnce(url){
  if(!audioArmed){ log("BLOCKED AUDIO"); return; }
  const a=new Audio(url);
  a.play().catch(e=>log("AUDIO ERR "+e));
}

/* ===================== LAYOUT ===================== */
function applyLayout(faction,color){
  const bg = LAYOUT_BG[faction] || LAYOUT_BG.mechanicus;
  document.documentElement.style.setProperty("--layout-bg",`url(${bg})`);
  document.documentElement.style.setProperty("--accent",color||"#00ff66");

  const inset = (faction==="inquisition") ? SCREEN_INSETS.inquisition : SCREEN_INSETS.default04;
  for(const k in inset){
    document.documentElement.style.setProperty(`--screen-${k}`,inset[k]);
  }

  el.panel.dataset.ar = (faction==="inquisition") ? "inq" : "04";
}

/* ===================== STANY ===================== */
function showIdle(){
  el.screen.style.display="none";
  el.prefix.textContent="";
  el.msg.textContent="";
  el.suffix.textContent="";
}

function showMessage(p,m,s){
  el.prefix.textContent=p||"";
  el.msg.textContent=m||"";
  el.suffix.textContent=s||"";
  el.screen.style.display="block";
}

/* ===================== FIRESTORE ===================== */
const ref = doc(db,"dataslate","current");
let lastNonce=null;

onSnapshot(ref,snap=>{
  if(!snap.exists()) return;
  const d=snap.data();
  if(d.nonce===lastNonce) return;
  lastNonce=d.nonce;

  log("EVENT "+d.type+" "+d.faction);

  applyLayout(d.faction,d.color);

  if(d.type==="clear"){
    showIdle();
    return;
  }

  if(d.type==="ping"){
    playOnce(d.pingUrl||DEFAULT_PING_URL);
    return;
  }

  if(d.type==="message"){
    showMessage(d.prefix,d.text,d.suffix);
    playOnce(d.msgUrl||DEFAULT_MSG_URL);
  }
});

/* START */
applyLayout("mechanicus","#00ff66");
showIdle();
log("ready");
</script>
</body>
</html>
