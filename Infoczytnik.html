<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>WH40k Data-Slate — Infoczytnik</title>

<!-- ✅ AUTO-CACHE-BUSTING (żeby tablet nie trzymał starej wersji) -->
<script>
  (function autoCacheBust(){
    const INF_VERSION = "2025-12-13-2"; // <- zmieniaj przy aktualizacjach
    const url = new URL(window.location.href);
    if (url.searchParams.get("v") !== INF_VERSION) {
      url.searchParams.set("v", INF_VERSION);
      window.location.replace(url.toString());
    }
  })();
</script>

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Cinzel:wght@400;700&family=Rajdhani:wght@400;600&family=Black+Ops+One&family=Staatliches&family=Orbitron:wght@400;700&family=Questrial&family=Russo+One&display=swap" rel="stylesheet">

<style>
  :root{
    --accent:#00ff66;
    --font: Calibri, Arial, sans-serif;

    --screen-top: 14%;
    --screen-right: 14%;
    --screen-bottom: 22%;
    --screen-left: 18%;

    --msg-font-size: clamp(18px, 3.4vw, 32px);
    --prefix-font-size: clamp(12px, 2.0vw, 16px);
    --suffix-font-size: clamp(12px, 2.0vw, 16px);

    --prefix-color: rgba(255,255,255,.88);
    --suffix-color: rgba(255,255,255,.86);
  }

  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background:#000; overflow:hidden;}
  body{color:var(--accent); font-family:var(--font);}

  .wrap{
    width:100vw; height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#000;
    overflow:hidden;
  }

  .panel{
    position:relative;
    overflow:hidden;
    background:#000;
  }

  .layout-img{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:contain;
    object-position:center;
    user-select:none;
    -webkit-user-drag:none;
    pointer-events:none;
  }

  .crt::before{
    content:"";
    position:absolute;
    inset:0;
    pointer-events:none;
    background:
      repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,.06) 0px,
        rgba(255,255,255,.06) 1px,
        rgba(0,0,0,0) 3px,
        rgba(0,0,0,0) 7px
      );
    opacity:.28;
    mix-blend-mode: overlay;
    animation: scanMove 12s linear infinite;
  }
  .crt::after{
    content:"";
    position:absolute;
    inset:-2%;
    pointer-events:none;
    background:
      radial-gradient(closest-side, rgba(0,0,0,0) 60%, rgba(0,0,0,.70) 100%),
      rgba(255,255,255,.04);
    opacity:.65;
    animation: flickerBg 9s infinite;
  }
  @keyframes scanMove { 0%{transform:translateY(0)} 100%{transform:translateY(20px)} }
  @keyframes flickerBg {
    0%,92%,100%{opacity:.65}
    93%{opacity:.55}
    95%{opacity:.72}
    97%{opacity:.60}
  }

  .screen{
    position:absolute;
    top:var(--screen-top);
    right:var(--screen-right);
    bottom:var(--screen-bottom);
    left:var(--screen-left);

    overflow:auto;
    -webkit-overflow-scrolling:touch;
    padding: clamp(14px, 2.4vw, 24px);
    display:block;
    text-shadow: 0 2px 6px rgba(0,0,0,.70);
  }

  .prefixRow{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap: 12px;
  }

  .prefix{
    flex: 1 1 auto;
    color: var(--prefix-color);
    font-size: var(--prefix-font-size);
    letter-spacing: 1.5px;
    margin: 0 0 10px 0;
    white-space: pre-wrap;
  }

  .logoBox{
    flex: 0 0 auto;
    width: 54px;
    height: 54px;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  .logo{
    width:100%;
    height:100%;
    object-fit:contain;
    object-position:center;
    opacity:.95;
    filter: drop-shadow(0 2px 6px rgba(0,0,0,.7));
    pointer-events:none;
    user-select:none;
    display:none;
  }

  .msg{
    position:relative;
    font-size: var(--msg-font-size);
    line-height: 1.35;
    white-space: pre-wrap;
    word-break: break-word;
    color: var(--accent);
    text-shadow: 0 0 18px rgba(0,255,120,.18), 0 2px 6px rgba(0,0,0,.70);
  }

  .suffixRow{display:flex; align-items:flex-start;}
  .suffix{
    color: var(--suffix-color);
    font-size: var(--suffix-font-size);
    letter-spacing: 1.5px;
    margin: 12px 0 0 0;
    white-space: pre-wrap;
  }

  .unlock{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,.88);
    color:rgba(255,255,255,.9);
    font-family: Calibri, Arial, sans-serif;
    z-index:9999;
    text-align:center;
    cursor:pointer;
    padding:24px;
  }
  .unlock .box{
    border:1px solid rgba(255,255,255,.18);
    border-radius:16px;
    padding:18px 16px;
    max-width:560px;
    background:rgba(0,0,0,.35);
  }
</style>
</head>

<body>
  <div class="unlock" id="unlock">
    <div class="box">
      <div style="font-size:18px; margin-bottom:8px;">Kliknij raz, aby odblokować dźwięk</div>
      <div style="font-size:13px; opacity:.78; line-height:1.35;">
        Chrome blokuje audio, dopóki w tej karcie nie wykonasz akcji.
        To jednorazowe (po odświeżeniu trzeba kliknąć ponownie).
      </div>
      <div style="margin-top:10px; font-size:12px; opacity:.6;">(Kliknij gdziekolwiek)</div>
    </div>
  </div>

  <div class="wrap">
    <div class="panel crt" id="panel">
      <img class="layout-img" id="layoutImg" alt="layout" />
      <div class="screen" id="screen">
        <div class="prefixRow">
          <div class="prefix" id="prefixLine"></div>
          <div class="logoBox">
            <img class="logo" id="logo" alt="logo" />
          </div>
        </div>

        <div class="msg" id="msg"></div>

        <div class="suffixRow">
          <div class="suffix" id="suffixLine"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ config jako zwykły skrypt (ustawia window.firebaseConfig) -->
  <script src="config/firebase-config.js"></script>

  <!-- ✅ Audio unlock działa NIEZALEŻNIE od Firebase (ważne!) -->
  <script>
    (function setupAudioUnlock(){
      const unlock = document.getElementById("unlock");
      window.__dsAudioArmed = false;

      function armAudio(){
        if (window.__dsAudioArmed) return;
        window.__dsAudioArmed = true;
        unlock.style.display = "none";
      }

      // możliwie najpewniejsze wejścia na mobile
      unlock.addEventListener("click", armAudio, { passive:true });
      unlock.addEventListener("touchstart", armAudio, { passive:true });
      window.addEventListener("pointerdown", armAudio, { passive:true });
      window.addEventListener("keydown", armAudio);

      window.__dsPlayUrlOnce = async function(url){
        if(!window.__dsAudioArmed) return;
        try { await new Audio(url).play(); } catch(e) {}
      };
    })();
  </script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = window.firebaseConfig;
  if(!firebaseConfig){
    console.error("Brak window.firebaseConfig — sprawdź config/firebase-config.js");
    // Nie blokujemy UI — tylko wyświetli się layout bez aktualizacji.
  }

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const ASSET_VERSION = "2025-12-13-1";

  const DEFAULT_PING_URL = `assets/audio/global/Ping.mp3?v=${ASSET_VERSION}`;
  const DEFAULT_MSG_URL  = `assets/audio/global/Message.mp3?v=${ASSET_VERSION}`;

  const LAYOUT_BG = {
    inquisition: `assets/layouts/inquisition/DataSlate_Inq.png?v=${ASSET_VERSION}`,
    mechanicus:  `assets/layouts/mechanicus/DataSlate_04.png?v=${ASSET_VERSION}`,
    militarum:   `assets/layouts/militarum/DataSlate_04.png?v=${ASSET_VERSION}`,
    chaos_undivided: `assets/layouts/chaos_undivided/DataSlate_04.png?v=${ASSET_VERSION}`,
    khorne:      `assets/layouts/khorne/DataSlate_04.png?v=${ASSET_VERSION}`,
    nurgle:      `assets/layouts/nurgle/DataSlate_04.png?v=${ASSET_VERSION}`,
    tzeentch:    `assets/layouts/tzeentch/DataSlate_04.png?v=${ASSET_VERSION}`,
    slaanesh:    `assets/layouts/slaanesh/DataSlate_04.png?v=${ASSET_VERSION}`,
  };

  const LAYOUT_AR = { inquisition: 707/1023, default04: 1131/1600 };
  const SCREEN_INSETS = {
    inquisition: { top:"14%", right:"14%", bottom:"26%", left:"18%" },
    default04:   { top:"14%", right:"14%", bottom:"22%", left:"18%" },
  };

  const FONT_STACK = {
    mechanicus:      '"Share Tech Mono", Calibri, Arial, sans-serif',
    inquisition:     '"Cinzel", Calibri, Arial, sans-serif',
    militarum:       '"Rajdhani", Calibri, Arial, sans-serif',
    khorne:          '"Black Ops One", Calibri, Arial, sans-serif',
    nurgle:          '"Staatliches", Calibri, Arial, sans-serif',
    tzeentch:        '"Orbitron", Calibri, Arial, sans-serif',
    slaanesh:        '"Questrial", Calibri, Arial, sans-serif',
    chaos_undivided: '"Russo One", Calibri, Arial, sans-serif',
  };

  const FILLERS = {
    mechanicus: {
      prefixes:["++ INCOMING DATA FEED ++","++ SYSTEM ANALYSIS BEGIN ++","++ ENCRYPTION ONLINE ++","++ ENGAGE LITURGY ++","++ ARCHIVE ACCESS ++","++ LOGIS-CHANNEL ACTIVE ++","++ DATA LINK ESTABLISHED ++","++ SIGNAL LOCKED ++","++ CORE STABILIZED ++"],
      suffixes:["++ PRAISE THE OMNISSIAH ++","++ MACHINE SPIRIT CALMED ++","++ THE FLESH IS WEAK ++","++ SYSTEM CLEANSED ++","++ BINARY PRAYER SENT ++","++ OMNISSIAH GUIDE US ++","++ SERVITOR READY ++","++ RITUAL COMPLETE ++","++ PRAY TO THE CODE ++"]
    },
    inquisition: {
      prefixes:["++ INQUISITORIAL NOTICE ++","++ DATA INTERCEPTED ++","++ DECRYPTING ORDER ++","++ ORDER: SIGMA-9 ++","++ COGITATOR ACCESS ++","++ BY HIS WILL ++","++ CLASSIFIED MATERIAL ++","++ MIND CLEANSED ++","++ CODEX SECURED ++"],
      suffixes:["++ THE EMPEROR PROTECTS ++","++ AUTHORIZATION VERIFIED ++","++ PURGE COMPLETE ++","++ FAITH REMAINS ++","++ THOUGHT FOR THE DAY ++","++ HERESY PURGED ++","++ OATH UPHELD ++","++ FAITH IS ARMOR ++","++ EXAMINATION COMPLETE ++"]
    }
  };

  const FACTION_LOGO = {
    inquisition: `assets/logos/inquisition/Inquisition.png?v=${ASSET_VERSION}`,
    mechanicus:  `assets/logos/mechanicus/Mechanicus.png?v=${ASSET_VERSION}`
  };

  const el = {
    panel: document.getElementById("panel"),
    layoutImg: document.getElementById("layoutImg"),
    screen: document.getElementById("screen"),
    prefixLine: document.getElementById("prefixLine"),
    suffixLine: document.getElementById("suffixLine"),
    msg: document.getElementById("msg"),
    logo: document.getElementById("logo"),
  };

  function fitPanel(ar){
    const vw = window.innerWidth, vh = window.innerHeight;
    let h = vh, w = h * ar;
    if(w > vw){ w = vw; h = w / ar; }
    el.panel.style.width  = Math.round(w) + "px";
    el.panel.style.height = Math.round(h) + "px";
  }

  function setInsets(p){
    document.documentElement.style.setProperty("--screen-top", p.top);
    document.documentElement.style.setProperty("--screen-right", p.right);
    document.documentElement.style.setProperty("--screen-bottom", p.bottom);
    document.documentElement.style.setProperty("--screen-left", p.left);
  }

  let currentAr = LAYOUT_AR.default04;

  function setLogoForFaction(key){
    const src = FACTION_LOGO[key];
    if(!src){
      el.logo.removeAttribute("src");
      el.logo.style.display = "none";
      return;
    }
    el.logo.src = src;
    el.logo.style.display = "block";
  }

  function getFillerText(key, idx1based, kind){
    const cfg = FILLERS[key] || FILLERS.mechanicus;
    const arr = (kind === "prefix") ? cfg.prefixes : cfg.suffixes;
    const n = Number(idx1based);
    const i = (Number.isFinite(n) ? Math.floor(n) : 1) - 1;
    return arr[Math.max(0, Math.min(arr.length - 1, i))] || "";
  }

  function applyLayout(factionKey, color){
    const key = (factionKey && LAYOUT_BG[factionKey]) ? factionKey : "mechanicus";
    el.layoutImg.src = LAYOUT_BG[key] || LAYOUT_BG.mechanicus;

    document.documentElement.style.setProperty("--font", FONT_STACK[key] || 'Calibri, Arial, sans-serif');
    document.documentElement.style.setProperty("--accent", color || "#00ff66");

    if(key === "inquisition"){
      setInsets(SCREEN_INSETS.inquisition);
      currentAr = LAYOUT_AR.inquisition;
    }else{
      setInsets(SCREEN_INSETS.default04);
      currentAr = LAYOUT_AR.default04;
    }
    fitPanel(currentAr);
    setLogoForFaction(key);
  }

  function applyTextStyleFromDoc(d){
    if(d.msgFontSize)    document.documentElement.style.setProperty("--msg-font-size", String(d.msgFontSize));
    if(d.prefixFontSize) document.documentElement.style.setProperty("--prefix-font-size", String(d.prefixFontSize));
    if(d.suffixFontSize) document.documentElement.style.setProperty("--suffix-font-size", String(d.suffixFontSize));
    if(d.prefixColor)    document.documentElement.style.setProperty("--prefix-color", String(d.prefixColor));
    if(d.suffixColor)    document.documentElement.style.setProperty("--suffix-color", String(d.suffixColor));
  }

  function showMessage(prefix, text, suffix){
    el.prefixLine.textContent = prefix || "";
    el.msg.textContent = text || "";
    el.suffixLine.textContent = suffix || "";
    el.screen.scrollTop = 0;
  }

  function clearMessageKeepLayout(){
    el.prefixLine.textContent = "";
    el.msg.textContent = "";
    el.suffixLine.textContent = "";
  }

  window.addEventListener("resize", () => fitPanel(currentAr));

  const currentRef = doc(db, "dataslate", "current");
  let lastNonce = null;

  onSnapshot(currentRef, (snap)=>{
    if(!snap.exists()) return;
    const d = snap.data() || {};

    if(d.nonce && d.nonce === lastNonce) return;
    lastNonce = d.nonce || null;

    const faction = d.faction || "mechanicus";
    const color   = d.color || d.fontColor || "#00ff66";

    applyLayout(faction, color);
    applyTextStyleFromDoc(d);

    if(d.type === "clear"){
      clearMessageKeepLayout();
      return;
    }

    if(d.type === "ping"){
      const pingUrl = d.pingUrl ? String(d.pingUrl) : DEFAULT_PING_URL;
      window.__dsPlayUrlOnce(pingUrl);
      return;
    }

    if(d.type === "message"){
      const text = d.text ?? "";

      let prefix = d.prefix ?? d.prefixText ?? "";
      let suffix = d.suffix ?? d.suffixText ?? "";

      if(!prefix && (d.prefixIndex || d.prefixIdx)){
        prefix = getFillerText(faction, d.prefixIndex || d.prefixIdx, "prefix");
      }
      if(!suffix && (d.suffixIndex || d.suffixIdx)){
        suffix = getFillerText(faction, d.suffixIndex || d.suffixIdx, "suffix");
      }

      if(!prefix && (text || "").trim()) prefix = getFillerText(faction, 1, "prefix");
      if(!suffix && (text || "").trim()) suffix = getFillerText(faction, 1, "suffix");

      if((text || "").trim().length === 0){
        clearMessageKeepLayout();
      }else{
        showMessage(prefix, text, suffix);
      }

      const msgUrl = (d.msgUrl || d.messageUrl) ? String(d.msgUrl || d.messageUrl) : DEFAULT_MSG_URL;
      window.__dsPlayUrlOnce(msgUrl);
    }
  });

  // Start
  applyLayout("mechanicus", "#00ff66");
</script>
</body>
</html>
