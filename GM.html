<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WH40k Data-Slate — GM</title>
  <style>
    :root{--text:#eaeaea;--muted:#bdbdbd;--accent:#ffd27a;--border:#2a2a2a;--panel:rgba(18,18,18,.92);}
    *{box-sizing:border-box}
    body{margin:0;padding:18px;font-family:Arial,sans-serif;background:linear-gradient(180deg,#070707,#0f0f0f);color:var(--text);}
    .wrap{max-width:980px;margin:0 auto}
    h1{margin:0 0 10px 0;font-size:20px;color:var(--accent);letter-spacing:.3px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);}
    label{display:block;margin:10px 0 6px 0;color:var(--muted);font-size:13px}
    select,textarea,input[type="number"],input[type="color"],input[type="text"]{
      width:100%;background:#0f0f0f;color:var(--text);border:1px solid var(--border);
      border-radius:10px;padding:10px 12px;font-size:16px;outline:none;
    }
    textarea{min-height:140px;resize:vertical;line-height:1.3}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1;min-width:240px}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      flex:1;min-width:160px;border:none;border-radius:12px;padding:12px 14px;font-size:16px;cursor:pointer;
      background:#1d1d1d;color:var(--text);border:1px solid var(--border);
    }
    button.primary{background:linear-gradient(180deg,#3a2a12,#1c1408);border:1px solid rgba(255,210,122,.35);color:var(--accent);}
    button.warn{background:linear-gradient(180deg,#1c0c0c,#120606);border:1px solid rgba(255,120,120,.25);color:#ffb3b3;}
    .small{margin-top:10px;font-size:12px;color:var(--muted)}
    .status{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border)}
    .preview{
      margin:10px 0 0 0;padding:10px 12px;border-radius:10px;border:1px dashed rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);color:#cfcfcf;font-family:Consolas,"Courier New",monospace;font-size:13px;white-space:pre-wrap;
    }
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.18);cursor:pointer;user-select:none;font-size:13px;color:#eaeaea;}
    .chip span{display:inline-block;width:12px;height:12px;border-radius:3px;margin-right:6px;vertical-align:-2px;border:1px solid rgba(0,0,0,.25)}

    /* ===== Układ: Losowość fillerów (Suffix wyrównany pod Prefix po prawej) ===== */
    .fillerBox{
      padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#0f0f0f;
    }
    .fillerTop{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;
    }
    .fillerTop input[type="checkbox"]{width:18px;height:18px;margin:0}
    .fillerManual{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:end;
    }
    .fillerManual .right{
      justify-self:end;
      width:min(260px, 100%);
    }
    .fillerManual .left{
      width:min(260px, 100%);
    }
    .miniLabel{
      color:#777;
      font-size:12px;
      margin-bottom:6px;
      display:block;
    }
    .pairRow{
      display:flex;gap:10px;align-items:center;justify-content:flex-end;
    }
    .pairRow b{color:#bdbdbd;font-weight:600}
    .pairRow input[type="number"]{width:110px}

    hr.sep{border:none;border-top:1px solid rgba(255,255,255,.08);margin:14px 0;}
    code{font-family:Consolas,"Courier New",monospace;font-size:12px;color:#ddd}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>WH40k Data-Slate — GM</h1>
    <div class="card">

      <div class="row">
        <!-- LEWA KOLUMNA -->
        <div class="col">
          <label>Frakcja / layout</label>
          <select id="faction">
            <option value="mechanicus">Adeptus Mechanicus</option>
            <option value="inquisition">Inkwizycja</option>
            <option value="militarum">Astra Militarum</option>
            <option value="khorne">Khorne</option>
            <option value="nurgle">Nurgle</option>
            <option value="tzeentch">Tzeentch</option>
            <option value="slaanesh">Slaanesh</option>
            <option value="chaos_undivided">Chaos Undivided</option>
          </select>

          <!-- Kolor treści + szybkie -->
          <label>Kolor fontu (treść wiadomości)</label>
          <input type="color" id="fontColor" value="#00ff66" />
          <div class="chips" id="msgColorChips">
            <div class="chip" data-target="msg" data-color="#00ff66"><span style="background:#00ff66"></span>Zielony</div>
            <div class="chip" data-target="msg" data-color="#ff3333"><span style="background:#ff3333"></span>Czerwony</div>
            <div class="chip" data-target="msg" data-color="#d4af37"><span style="background:#d4af37"></span>Złoty</div>
            <div class="chip" data-target="msg" data-color="#ffffff"><span style="background:#ffffff"></span>Biały</div>
          </div>

          <!-- Rozmiar treści -->
          <label>Wielkość fontu (treść wiadomości) — px</label>
          <input type="number" id="msgFontSize" min="12" max="80" step="1" value="28" />

          <hr class="sep">

          <!-- Kolor Prefix+Suffix -->
          <label>Kolor Prefix + Suffix (wspólny)</label>
          <div class="row" style="gap:10px;">
            <div class="col" style="min-width:180px;">
              <input type="text" id="psColorText" value="rgba(255,255,255,.88)" />
              <div class="small">Możesz wpisać np. <code>#ffffff</code> albo <code>rgba(255,255,255,.88)</code></div>
            </div>
            <div class="col" style="min-width:160px;">
              <input type="color" id="psColorPicker" value="#ffffff" />
              <div class="small">Picker ustawia kolor jako <code>#RRGGBB</code></div>
            </div>
          </div>

          <!-- Szybkie kolory Prefix/Suffix -->
          <div class="chips" id="psColorChips">
            <div class="chip" data-target="ps" data-color="#00ff66"><span style="background:#00ff66"></span>Zielony</div>
            <div class="chip" data-target="ps" data-color="#ff3333"><span style="background:#ff3333"></span>Czerwony</div>
            <div class="chip" data-target="ps" data-color="#d4af37"><span style="background:#d4af37"></span>Złoty</div>
            <div class="chip" data-target="ps" data-color="#ffffff"><span style="background:#ffffff"></span>Biały</div>
          </div>

          <!-- Rozmiar Prefix/Suffix -->
          <label>Wielkość fontu Prefix + Suffix (wspólna) — px</label>
          <input type="number" id="psFontSize" min="10" max="60" step="1" value="14" />

          <div class="small">
            Logo ma stały rozmiar w Infoczytniku. Zmiana rozmiaru prefixu może spowodować zawijanie (OK), logo zostaje bez zmian.
          </div>
        </div>

        <!-- PRAWA KOLUMNA -->
        <div class="col">
          <label>Losowość fillerów</label>

          <div class="fillerBox">
            <div class="fillerTop">
              <input type="checkbox" id="randomFillers" checked />
              <span>Losuj automatycznie</span>
            </div>

            <div class="fillerManual">
              <div class="left">
                <span class="miniLabel">Ręcznie</span>
                <div class="pairRow">
                  <b>Prefix</b>
                  <input type="number" id="prefixIndex" min="1" value="1" />
                </div>
              </div>

              <div class="right">
                <div class="pairRow">
                  <b>Suffix</b>
                  <input type="number" id="suffixIndex" min="1" value="1" />
                </div>
              </div>
            </div>
          </div>

          <div class="small">
            Gdy losowanie wyłączone, wybierasz osobno numer Prefix i Suffix (1..N zależnie od frakcji).
          </div>
        </div>
      </div>

      <div class="preview" id="prefixPreview"></div>

      <label>Treść komunikatu</label>
      <textarea id="message" placeholder="Wpisz komunikat dla graczy..."></textarea>

      <div class="preview" id="suffixPreview"></div>

      <div class="btnrow">
        <button class="primary" id="sendBtn">Wyślij</button>
        <button class="warn" id="pingBtn">Ping</button>
        <button id="clearBtn">Wyczyść ekran</button>
        <button id="clearTextBtn">Wyczyść pole</button>
      </div>

      <div class="small">Status: <span class="status" id="status">…</span></div>
    </div>
  </div>

  <!-- ✅ Firebase config jako GLOBAL (window.firebaseConfig) -->
  <script src="config/firebase-config.js"></script>

  <!-- Firebase compat (działa w zwykłym <script>) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-firestore-compat.js"></script>

  <script>
    // --- Konfiguracja Firebase z config/firebase-config.js ---
    const firebaseConfig = window.firebaseConfig;
    if(!firebaseConfig){
      alert("Brak window.firebaseConfig. Sprawdź plik config/firebase-config.js");
      throw new Error("Missing window.firebaseConfig");
    }

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const currentRef = db.collection("dataslate").doc("current");

    const el = {
      faction: document.getElementById("faction"),

      // treść wiadomości
      fontColor: document.getElementById("fontColor"),
      msgFontSize: document.getElementById("msgFontSize"),

      // prefix/suffix styl
      psColorText: document.getElementById("psColorText"),
      psColorPicker: document.getElementById("psColorPicker"),
      psFontSize: document.getElementById("psFontSize"),

      // fillery
      randomFillers: document.getElementById("randomFillers"),
      prefixIndex: document.getElementById("prefixIndex"),
      suffixIndex: document.getElementById("suffixIndex"),

      // message
      message: document.getElementById("message"),

      // buttons
      sendBtn: document.getElementById("sendBtn"),
      clearBtn: document.getElementById("clearBtn"),
      clearTextBtn: document.getElementById("clearTextBtn"),
      pingBtn: document.getElementById("pingBtn"),

      // ui
      status: document.getElementById("status"),
      prefixPreview: document.getElementById("prefixPreview"),
      suffixPreview: document.getElementById("suffixPreview"),

      // chips
      chips: Array.from(document.querySelectorAll(".chip")),
    };

    const LAYOUTS = {
      mechanicus:{prefixes:["++ INCOMING DATA FEED ++","++ SYSTEM ANALYSIS BEGIN ++","++ ENCRYPTION ONLINE ++","++ ENGAGE LITURGY ++","++ ARCHIVE ACCESS ++","++ LOGIS-CHANNEL ACTIVE ++","++ DATA LINK ESTABLISHED ++","++ SIGNAL LOCKED ++","++ CORE STABILIZED ++"],
                 suffixes:["++ PRAISE THE OMNISSIAH ++","++ MACHINE SPIRIT CALMED ++","++ THE FLESH IS WEAK ++","++ SYSTEM CLEANSED ++","++ BINARY PRAYER SENT ++","++ OMNISSIAH GUIDE US ++","++ SERVITOR READY ++","++ RITUAL COMPLETE ++","++ PRAY TO THE CODE ++"]},
      inquisition:{prefixes:["++ INQUISITORIAL NOTICE ++","++ DATA INTERCEPTED ++","++ DECRYPTING ORDER ++","++ ORDER: SIGMA-9 ++","++ COGITATOR ACCESS ++","++ BY HIS WILL ++","++ CLASSIFIED MATERIAL ++","++ MIND CLEANSED ++","++ CODEX SECURED ++"],
                  suffixes:["++ THE EMPEROR PROTECTS ++","++ AUTHORIZATION VERIFIED ++","++ PURGE COMPLETE ++","++ FAITH REMAINS ++","++ THOUGHT FOR THE DAY ++","++ HERESY PURGED ++","++ OATH UPHELD ++","++ FAITH IS ARMOR ++","++ EXAMINATION COMPLETE ++"]},
      militarum:{prefixes:["++ IMPERIAL SIGNAL ++","++ HIGH COMMAND ORDER ++","++ ORDERS INCOMING ++","++ TACTICAL FEED ++","++ REGIMENTAL DATA ++","++ COMMAND OVERRIDE ++","++ BATTLELINE UPLINK ++","++ ENGAGEMENT ACTIVE ++","++ OPERATIONAL BRIEF ++"],
                 suffixes:["++ GLORY TO THE GUARD ++","++ VICTORY IS ASSURED ++","++ CADIA STANDS ++","++ DUTY FULFILLED ++","++ NO SACRIFICE TOO GREAT ++","++ PERIMETER SECURED ++","++ FOR THE EMPEROR ++","++ STATUS: GREEN ++","++ STRATEGIC DIRECTIVE ++"]},
      khorne:{prefixes:["++ BLOOD ALERT ++","++ SKULL COUNT RISING ++","++ RAGE TRANSMISSION ++","++ COMBAT UPLINK ++","++ SLAUGHTER INITIATED ++","++ VIOLENCE MAXIMUM ++","++ NO PEACE ONLY WAR ++","++ RIP THEIR HEADS ++","++ DOMINATE THROUGH BLOOD ++"],
              suffixes:["++ BLOOD FOR THE BLOOD GOD ++","++ SKULLS FOR THE THRONE ++","++ RIP AND TEAR ++","++ ALL MUST BLEED ++","++ DEATH WITHOUT END ++","++ STRIKE WITHOUT MERCY ++","++ AXE ONLINE ++","++ RED FLOWS ++","++ KILL. MAIM. BURN. ++"]},
      nurgle:{prefixes:["++ BLOAT SIGNAL ++","++ DECAY INITIATED ++","++ DISEASE VECTOR ACTIVE ++","++ PLAGUE SEED SENT ++","++ SPOREFIELD DEPLOYED ++","++ VIRUSCODE ENGAGED ++","++ ALL IS ROT ++","++ FLESH SAGS ++","++ FOULNESS RISES ++"],
              suffixes:["++ PRAISE GRANDPA NURGLE ++","++ FILTH TRANSMITTED ++","++ ROTTEN JOY ++","++ CONTAGION SPREADS ++","++ FLIES REJOICE ++","++ FESTERING COMPLETE ++","++ MUCOUS FLOW ++","++ BLESSINGS OF ROT ++","++ CORRUPTION GLORIOUS ++"]},
      tzeentch:{prefixes:["++ KNOWLEDGE UNFOLDS ++","++ SCHEME RUNNING ++","++ DATA TWISTED ++","++ WARP-TEXT INCOMING ++","++ INVERSION ACTIVE ++","++ DESTINY WRITTEN ++","++ NOTHING IS AS IT SEEMS ++","++ PATTERNS SHIFT ++","++ BURN THE SCRIPT ++"],
               suffixes:["++ ALL IS CHANGE ++","++ PLAN: PHASE 7 ++","++ EYE OPENS ++","++ BIRD OF FATE SMILES ++","++ THOUGHT MUTATED ++","++ CYCLE CONTINUES ++","++ OBSERVE THE CHANGE ++","++ REWRITE EVERYTHING ++","++ JUST AS PLANNED ++"]},
      slaanesh:{prefixes:["++ ECSTASY PULSE ++","++ SENSORY OVERLOAD ++","++ LUXURY CHANNEL OPEN ++","++ VELVET SIGNAL ++","++ DESIRE BREACH ++","++ TOUCH THE DIVINE ++","++ TASTE THE PAIN ++","++ LUSTWAVE TRANSMITTED ++","++ EXCESS COMPLETE ++"],
               suffixes:["++ FEED THE HUNGER ++","++ THE PERFECT MOMENT ++","++ PAIN IS PLEASURE ++","++ EXCESS IS TRUTH ++","++ PLEASURE SATURATED ++","++ UNHOLY HARMONY ++","++ FEEL EVERYTHING ++","++ TEMPTATION SPIKE ++","++ PERFECTION IS BLISS ++"]},
      chaos_undivided:{prefixes:["++ WARP STIRRING ++","++ TRANSMISSION CORRUPTED ++","++ HERESY INBOUND ++","++ WARP SIGNATURE FOUND ++","++ SACRIFICE ACCEPTED ++","++ WARP ENERGY RISING ++","++ ORDER BREAKS ++","++ FLESH TURNS ++","++ ASCENSION IMMINENT ++"],
                      suffixes:["++ GLORY TO CHAOS ++","++ DARK GODS SMILE ++","++ THE EYE OPENS ++","++ ASCEND AND BURN ++","++ ALL HAIL THE DARK GODS ++","++ REALSPACE BLEEDS ++","++ STARS ARE WRONG ++","++ VOID WITHIN ++","++ ETERNAL CHANGE ++"]},
    };

    function setStatus(t){ el.status.textContent = t; }
    function clampIndex(n, max){ const x=Number(n); if(!Number.isFinite(x)) return 1; return Math.min(max, Math.max(1, Math.floor(x))); }
    function rand1to(max){ return Math.floor(Math.random()*max)+1; }
    function nonce(){ return String(Date.now()) + "-" + String(Math.random()).slice(2); }
    function getLayout(){ return LAYOUTS[el.faction.value] || LAYOUTS.mechanicus; }

    function normalizePx(n, min, max, fallback){
      const x = Number(n);
      if(!Number.isFinite(x)) return fallback;
      return Math.max(min, Math.min(max, Math.floor(x)));
    }

    function getPrefixSuffixColor(){
      const t = (el.psColorText.value || "").trim();
      return t || "rgba(255,255,255,.88)";
    }

    function computePreview(){
      const cfg=getLayout();
      const pMax=cfg.prefixes.length, sMax=cfg.suffixes.length;

      const pIdx=el.randomFillers.checked ? rand1to(pMax) : clampIndex(el.prefixIndex.value, pMax);
      const sIdx=el.randomFillers.checked ? rand1to(sMax) : clampIndex(el.suffixIndex.value, sMax);

      el.prefixPreview.textContent = cfg.prefixes[pIdx-1] || "";
      el.suffixPreview.textContent = cfg.suffixes[sIdx-1] || "";

      // blokuj ręczne pola gdy losuje
      const manualDisabled = el.randomFillers.checked;
      el.prefixIndex.disabled = manualDisabled;
      el.suffixIndex.disabled = manualDisabled;
    }

    async function sendMessage(isClear){
      const cfg=getLayout();
      const pMax=cfg.prefixes.length, sMax=cfg.suffixes.length;

      const prefixIndex=el.randomFillers.checked ? rand1to(pMax) : clampIndex(el.prefixIndex.value, pMax);
      const suffixIndex=el.randomFillers.checked ? rand1to(sMax) : clampIndex(el.suffixIndex.value, sMax);

      const msgFontPx = normalizePx(el.msgFontSize.value, 12, 80, 28);
      const psFontPx  = normalizePx(el.psFontSize.value, 10, 60, 14);

      setStatus("wysyłam…");
      try{
        await currentRef.set({
          type: isClear ? "clear" : "message",
          faction: el.faction.value,

          // treść wiadomości
          color: el.fontColor.value || "#00ff66",
          fontColor: el.fontColor.value || "#00ff66",
          msgFontSize: msgFontPx + "px",

          // prefix/suffix styl
          prefixColor: getPrefixSuffixColor(),
          suffixColor: getPrefixSuffixColor(),
          prefixFontSize: psFontPx + "px",
          suffixFontSize: psFontPx + "px",

          // fillery
          prefixIndex, suffixIndex,

          // tekst
          text: isClear ? "" : (el.message.value || ""),

          nonce: nonce(),
          ts: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:false });

        setStatus(isClear ? "wyczyszczono" : "wysłano");
      }catch(e){
        console.error(e);
        setStatus("BŁĄD");
        alert("Błąd zapisu:\n\n" + (e?.message || e));
      }
      computePreview();
    }

    async function ping(){
      const msgFontPx = normalizePx(el.msgFontSize.value, 12, 80, 28);
      const psFontPx  = normalizePx(el.psFontSize.value, 10, 60, 14);

      setStatus("ping…");
      try{
        await currentRef.set({
          type:"ping",
          faction: el.faction.value,

          // zostawiamy styl w docu, żeby nie “gubić” ustawień
          color: el.fontColor.value || "#00ff66",
          fontColor: el.fontColor.value || "#00ff66",
          msgFontSize: msgFontPx + "px",
          prefixColor: getPrefixSuffixColor(),
          suffixColor: getPrefixSuffixColor(),
          prefixFontSize: psFontPx + "px",
          suffixFontSize: psFontPx + "px",

          nonce: nonce(),
          ts: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });

        setStatus("ping wysłany");
      }catch(e){
        console.error(e);
        setStatus("BŁĄD ping");
        alert("Błąd ping:\n\n" + (e?.message || e));
      }
    }

    // ====== EVENTY ======
    el.sendBtn.addEventListener("click", () => sendMessage(false));
    el.clearBtn.addEventListener("click", () => sendMessage(true));
    el.pingBtn.addEventListener("click", ping);

    el.clearTextBtn.addEventListener("click", () => {
      el.message.value = "";
      el.message.focus();
    });

    // chips (msg i ps)
    el.chips.forEach(ch => ch.addEventListener("click", () => {
      const target = ch.getAttribute("data-target");
      const c = ch.getAttribute("data-color");
      if(!c) return;

      if(target === "msg"){
        el.fontColor.value = c;
      }else if(target === "ps"){
        el.psColorText.value = c;
        if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(c)){
          el.psColorPicker.value = (c.length===4)
            ? ("#" + c[1]+c[1]+c[2]+c[2]+c[3]+c[3])
            : c;
        }
      }
    }));

    // picker prefix/suffix -> ustawia tekst na #RRGGBB
    el.psColorPicker.addEventListener("input", () => {
      el.psColorText.value = el.psColorPicker.value;
    });

    ["change","input"].forEach(evt=>{
      el.faction.addEventListener(evt, computePreview);
      el.randomFillers.addEventListener(evt, computePreview);
      el.prefixIndex.addEventListener(evt, computePreview);
      el.suffixIndex.addEventListener(evt, computePreview);
    });

    setStatus("gotowe");
    computePreview();
  </script>
</body>
</html>
